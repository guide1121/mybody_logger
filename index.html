<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bulking Dashboard Pro üöÄ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #FFD700; --bg: #121212; --card: #1e1e1e; --text: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); padding: 20px; display: flex; justify-content: center; margin: 0; padding-bottom: 50px; }
        .container { width: 100%; max-width: 420px; }
        
        /* ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ï‡πà‡∏≤‡∏á‡πÜ */
        .card { background-color: var(--card); padding: 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .prediction-date { font-size: 1.8em; font-weight: bold; color: var(--primary); text-align: center; }
        .chart-container { height: 250px; }

        /* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ */
        .history-table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        .history-table th { text-align: left; color: #888; padding-bottom: 10px; border-bottom: 1px solid #333; }
        .history-table td { padding: 10px 0; border-bottom: 1px solid #2a2a2a; vertical-align: middle; }
        .status-badge { padding: 4px 8px; border-radius: 6px; font-size: 0.8em; font-weight: bold; display: inline-block; }
        .status-red { background-color: rgba(255, 77, 77, 0.2); color: #ff4d4d; } /* ‡∏Ç‡∏≤‡∏î */
        .status-green { background-color: rgba(74, 222, 128, 0.2); color: #4ade80; } /* ‡∏Ñ‡∏£‡∏ö */
        .menu-text { font-size: 0.85em; color: #aaa; margin-top: 3px; display: block; }

        /* ‡∏ü‡∏≠‡∏£‡πå‡∏° */
        input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #444; background: #2c2c2c; color: white; margin-bottom: 10px; box-sizing: border-box; }
        .macro-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        button { width: 100%; padding: 16px; background: var(--primary); color: black; font-weight: bold; border: none; border-radius: 8px; margin-top: 10px; cursor: pointer; }
        label { display: block; margin-bottom: 5px; color: #888; font-size: 0.8em; }
        #status { text-align: center; margin-top: 10px; height: 20px; }
        .success { color: #4ade80; }
    </style>
</head>
<body>

<div class="container">
        <div class="card">
        <h3 style="margin-top:0; color:var(--primary);">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏°‡∏∑‡πâ‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h3>
        <form id="foodForm">
            <label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π</label>
            <input type="text" id="menu" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡πâ‡∏≤‡∏ß‡∏°‡∏±‡∏ô‡πÑ‡∏Å‡πà" required>
            <label>üî• ‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà</label>
            <input type="number" id="cal" placeholder="0" required>
            <div class="macro-grid">
                <div><label>‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô</label><input type="number" id="prot" placeholder="g"></div>
                <div><label>‡∏Ñ‡∏≤‡∏£‡πå‡∏ö</label><input type="number" id="carb" placeholder="g"></div>
                <div><label>‡πÑ‡∏Ç‡∏°‡∏±‡∏ô</label><input type="number" id="fat" placeholder="g"></div>
            </div>
            <button type="submit" id="submitBtn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            <div id="status"></div>
        </form>
    </div>
    <br>
    <div class="card">
        <div style="text-align: center; color: #aaa; font-size: 0.9em;">üìÖ ‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏ñ‡∏∂‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</div>
        <div class="prediction-date" id="goalDate">...</div>
    </div>

    <div class="card chart-container">
        <canvas id="myChart"></canvas>
    </div>

    <div class="card">
        <h3 style="margin-top:0; color:var(--primary);">üìú ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 7 ‡∏ß‡∏±‡∏ô</h3>
        <table class="history-table">
            <thead>
                <tr>
                    <th width="20%">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                    <th width="40%">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                    <th width="40%" style="text-align:right;">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</th>
                </tr>
            </thead>
            <tbody id="historyList">
                </tbody>
        </table>
    </div>


</div>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw8jk_2W3xDeIBHgijELxRzJFGhCql7vhkg3L56J2Qf6wDe7DOUDv794ARvM_bNdi505w/exec'; // ‚ö†Ô∏è ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà

    async function loadDashboard() {
        try {
            const response = await fetch(SCRIPT_URL);
            const data = await response.json();
            
            // 1. ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢
            document.getElementById('goalDate').textContent = data.successDate || "-";

            // 2. ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü
            renderChart(data.chartData);

            // 3. ‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏°‡πà)
            renderHistory(data.chartData);

        } catch (error) { console.error(error); }
    }

    function renderHistory(data) {
        const tbody = document.getElementById('historyList');
        tbody.innerHTML = ''; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤

        // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö (‡πÄ‡∏≠‡∏≤‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô)
        for (let i = data.labels.length - 1; i >= 0; i--) {
            const date = data.labels[i];
            const menu = data.menus[i] || "-";
            const cal = data.cals[i];
            const diff = data.statuses[i]; // ‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á

            const tr = document.createElement('tr');
            
            // ‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡∏™‡∏µ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
            let statusHtml = '';
            if (diff >= 0) {
                statusHtml = `<span class="status-badge status-green">‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß (+${diff})</span>`;
            } else {
                statusHtml = `<span class="status-badge status-red">‡∏Ç‡∏≤‡∏î ${Math.abs(diff)}</span>`;
            }

            tr.innerHTML = `
                <td><b>${date}</b></td>
                <td>
                    <div style="font-weight:bold;">${cal} kcal</div>
                    <span class="menu-text">${menu.substring(0, 15)}...</span>
                </td>
                <td style="text-align:right;">${statusHtml}</td>
            `;
            tbody.appendChild(tr);
        }
    }

    function renderChart(data) {
        const ctx = document.getElementById('myChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [
                    { label: '‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà', data: data.cals, backgroundColor: '#FFD700', borderRadius: 4, order: 2 },
                    { label: '‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å', data: data.weights, borderColor: '#FF6B6B', type: 'line', yAxisID: 'y1', order: 1 }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    y: { display: false },
                    y1: { position: 'right', grid: { display: false } }
                },
                plugins: { legend: { display: false } }
            }
        });
    }

    loadDashboard();

    // ‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    const form = document.getElementById('foodForm');
    const btn = document.getElementById('submitBtn');
    const statusDiv = document.getElementById('status');

    form.addEventListener('submit', e => {
        e.preventDefault();
        btn.disabled = true; btn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
        
        fetch(SCRIPT_URL, {
            method: 'POST', mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                menu: document.getElementById('menu').value,
                cal: document.getElementById('cal').value || 0,
                prot: document.getElementById('prot').value || 0,
                carb: document.getElementById('carb').value || 0,
                fat: document.getElementById('fat').value || 0
            })
        }).then(() => {
            statusDiv.textContent = '‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!'; statusDiv.className = 'success';
            form.reset();
            setTimeout(() => { btn.disabled = false; btn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'; statusDiv.textContent=''; loadDashboard(); }, 2000);
        });
    });
</script>

</body>
</html>